---
title: "nuspectral demo"
author: Julien Emile-Geay
date: December 21, 2018
output: github_document
---

First we generate synthetic colored noise with Milankovitch frequencies.
For the background, we use the method of Kirchner, J. W. (2005), Aliasing in 1/fα noise spectra: Origins, consequences, and remedies, Physical Review E, 71(6), 066,110–, doi:10.1103/PhysRevE.71.066110.
```{r}
library(ggplot2)
library(ggthemes)
dt = 2
time = seq(dt,3000,by=dt)
nt = as.numeric(length(time))
nf = nt
y = matrix(nrow = nt, ncol = nf)
alpha = 1 # noise color
fs = 1/dt
f0 = fs/nt
theta = 2*pi*runif(nf)

for(k in 1:nf){
  y[,k] = (f0*k)^(-alpha/2)*sin(2*k*f0*time + theta[k])
}
ys = scale(rowSums(y))  # add up and scale
# add Milankovitch harmonics
periods = c(100,41,23,19)
amp = 1
np = length(periods)
yp = y = matrix(nrow = nt, ncol = np)
for(i in 1:np){
  yp[,i] = amp*sin(2*pi/periods[i]*time)
}

yp = rowSums(yp)  # add up

yt = ys + yp

# plot
ggplot() + geom_line(aes(x=time,y=yt),colour="orange") + ggtitle("Colored Milankovitch noise") + ylab("d18O") + scale_x_continuous(breaks=seq(0,5)) + xlab("Age (ka)") + theme_hc(base_size = 12, base_family = "sans", style = "darkunica", bgcolor = NULL)
```


```{r}
library(geoChronR)
library(nuspectral)
library(astrochron)
# WWZ method
tau = seq(min(time),max(time),length = max(nt %/% 2,5))
#spec.wwz = nuspectral:::nuwavelet_psd(time,yt,sigma=0.01,taus = tau)
load('spec.wwz.Rdata')
period_range =  c(10, 1000) 
freq = spec.wwz$Frequency
f.low = 1/period_range[2]
f.high = 1/period_range[1]
freq_range = (freq>= f.low & freq<=f.high)


# add power-law fit
dof = 2
specIn = data.frame(cbind(spec.wwz$Frequency, spec.wwz$Power))
resFit = astrochron::pwrLawFit(specIn, dof = dof, flow = f.low, fhigh = f.high, output = 1, genplot = F)
pwrLawFreq = resFit[, 1]
pwrLawLine = resFit[, 4]
# estimate range
m <- floor(log10(min(spec.wwz$Power[freq_range]))) 
M <- ceiling(log10(max(spec.wwz$Power[freq_range]))) 

#geom_line(aes(x=1/f,y=spec.mtmPL$PowerLaw_fit),colour="blue")

period_ticks= c(10, 20, 50, 100, 200, 500, 1000)
ggplot() + geom_line(aes(x=1/spec.wwz$Frequency,y=spec.wwz$Power),colour="orange") + scale_x_continuous(breaks=period_ticks, trans=geoChronR::reverselog_trans(10), limits = rev(period_range)) + xlab("Period (kyr)") + ylab("Normalized Power") + ggtitle("Colored Milankovitch noise, WWZ, power-law null") + scale_y_log10(limits = c(10^m,10^M)) + geom_line(aes(x=1/pwrLawFreq,y=pwrLawLine),colour="chartreuse") + theme_hc(base_size = 12, base_family = "sans", style = "darkunica", bgcolor = NULL)
```

We see four peaks at the frequencies where we put them (reassuiring, innit?) and a well characterized background with a 1/f slope (again, reassuring as that's what we put in). Note that the default value of sigma (0.05) would give an overly smooth spectrum. 
Also, you may want to play with the tau vector. Making it sparser will speed things up, though high-frequency variability will be undersampled. It thus requires some careful consideration. Here we choose to skip every other point, as a 4,000 interval stil allows to resolve Milankovitch frequencies. 

